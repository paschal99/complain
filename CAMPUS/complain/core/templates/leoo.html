{% extends 'Building/building_home.html' %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Pending Complaints</h2>
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>Student</th>
          <th>Subject</th>
          <th>Description</th>
          <th>Created At</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for complaint in pending_complaints %}
        <tr>
          <td>{{ complaint.student }}</td>
          <td>{{ complaint.subject }}</td>
          <td>{{ complaint.description }}</td>
          <td>{{ complaint.created_at }}</td>
          <td>
            <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#updateComplaintModal" data-id="{{ complaint.id }}" data-location="{{ complaint.location }}">Update</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Pagination -->
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% if pending_complaints.has_previous %}
        <li class="page-item"><a class="page-link" href="?page=1">&laquo; First</a></li>
        <li class="page-item"><a class="page-link" href="?page={{ pending_complaints.previous_page_number }}">Previous</a></li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">
          Page {{ pending_complaints.number }} of {{ pending_complaints.paginator.num_pages }}
        </span>
      </li>

      {% if pending_complaints.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ pending_complaints.next_page_number }}">Next</a></li>
        <li class="page-item"><a class="page-link" href="?page={{ pending_complaints.paginator.num_pages }}">Last &raquo;</a></li>
      {% endif %}
    </ul>
  </nav>
</div>

<!-- Update Complaint Modal -->
<div class="modal fade" id="updateComplaintModal" tabindex="-1" aria-labelledby="updateComplaintModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateComplaintModalLabel">Update Complaint</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="updateComplaintForm" method="post" class="needs-validation" novalidate>
          {% csrf_token %}
          <input type="hidden" id="complaintId" name="complaintId">
          <div class="form-group">
            <label for="location">Location:</label>
            <select class="form-control" id="location" name="location" required>
              {% for choice in complaint.location_choices %}
                  <option value="{{ choice.0 }}" {% if choice.0 == complaint.location %}selected{% endif %}>{{ choice.1 }}</option>
              {% endfor %}
          </select>
            <div class="invalid-feedback">
              Please select a location.
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Submit to Building Estate</button>
        </form>
        <div id="formError" class="alert alert-danger mt-2 d-none" role="alert">
          An error occurred. Please try again.
        </div>
        <div id="formSuccess" class="alert alert-success mt-2 d-none" role="alert">
          Complaint updated successfully!
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
  $(document).ready(function() {
    $('#updateComplaintModal').on('show.bs.modal', function(event) {
      var button = $(event.relatedTarget);
      var complaintId = button.data('id');
      var location = button.data('location');
      
      var modal = $(this);
      modal.find('#complaintId').val(complaintId);
      modal.find('#location').val(location);
    });

    $('#updateComplaintForm').on('submit', function(event) {
      event.preventDefault();
      if (this.checkValidity() === false) {
        event.stopPropagation();
        $(this).addClass('was-validated');
        return;
      }

      var form = $(this);
      $.ajaxSetup({
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      });
      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: form.serialize(),
        success: function(response) {
          $('#formSuccess').removeClass('d-none');
          $('#formError').addClass('d-none');
          $('#updateComplaintForm')[0].reset();
          $('#updateComplaintForm').removeClass('was-validated');
          setTimeout(function() {
            $('#updateComplaintModal').modal('hide');
            $('#formSuccess').addClass('d-none');
            location.reload(); // Reload page to reflect changes
          }, 2000);
        },
        error: function(response) {
          $('#formError').removeClass('d-none');
        }
      });
    });
  });
</script>
{% endblock %}
